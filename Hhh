from dataclasses import dataclass
from typing import Dict, Optional, List
import numpy as np
from sentence_transformers import SentenceTransformer


@dataclass
class Chunk:
    """Text chunk with metadata and embedding."""
    id: str
    text: str
    vector: Optional[np.ndarray]
    metadata: Dict


class LocalEmbedder:
    """
    Offline embedding generator using local nomic-embed-text-v1.5 model.
    Model path: models/nomic-embed-text-v1.5
    """

    def __init__(self, model_path: str = "models/nomic-embed-text-v1.5"):
        self.model_path = model_path
        print(f"Loading local embedding model from: {self.model_path}")

        try:
            self.model = SentenceTransformer(self.model_path)
            print("Model loaded successfully!")
        except Exception as e:
            raise RuntimeError(
                f"ERROR: Cannot load model from {self.model_path}\n"
                f"Ensure the directory exists and contains the HF files.\n\n{e}"
            )

    def embed_text(self, text: str) -> np.ndarray:
        """Generate embedding for a single text."""
        try:
            vec = self.model.encode(text, show_progress_bar=False)
            return np.array(vec, dtype=np.float32)
        except Exception as e:
            print(f"Embedding error: {e}")
            return np.zeros(768, dtype=np.float32)  # fallback

    def embed_chunks(self, chunks: List[Chunk]) -> List[Chunk]:
        """Generate embeddings for a list of chunks."""
        print(f"Generating embeddings for {len(chunks)} chunks...")

        for i, chunk in enumerate(chunks):
            if i % 10 == 0 and i > 0:
                print(f" progress: {i}/{len(chunks)}")

            chunk.vector = self.embed_text(chunk.text)

        print("Embeddings complete!")
        return chunks


print("Local embedder ready!")
